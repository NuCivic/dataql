/*! CHANGE_NAME v0.1 */
!function(a){"use strict";function b(){var a=this;a._select=[],a._aggregate=[]}b.fn={},b.fn.sum=function(a,b,c){var d=c.groupStament,e=a.field,f=a.as||a.field;return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][f]=(a[c][f]||0)+b[e],a}return a[f]=(a[f]||0)+b[e],a},{})},b.fn.count=function(a,b,c){var d=c.groupStament,e=a.as||"count";return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][e]=(a[c][e]||0)+1,a}return a[e]=(a[e]||0)+1,a},{})},b.fn.avg=function(a,b,c){var d=c.groupStament,e=a.field,f=a.as||"avg",g=_.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c].total=(a[c].total||0)+b[e],a[c].count=(a[c].count||0)+1,a[c].count&&a[c].total&&(a[c][f]=a[c].total/a[c].count),a}return a.total=(a.total||0)+b[e],a.count=(a.count||0)+1,a.count&&a.total&&(a[f]=a.total/a.count),a},{});return d?_.object(_.map(g,function(a,b){return[b,_.omit(a,"total","count")]})):_.omit(g,"total","count")},b.fn.max=function(a,b,c){var d=c.groupStament,e=a.as||"max",f=a.field;return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][e]=a[c][e]||b[f],b[f]>a[c][e]&&(a[c][e]=b[f]),a}return a[e]=a[e]||b[f],b[f]>a[e]&&(a[e]=b[f]),a},{})},b.fn.min=function(a,b,c){var d=c.groupStament,e=a.as||"min",f=a.field;return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][e]=a[c][e]||b[f],b[f]<a[c][e]&&(a[c][e]=b[f]),a}return a[e]=a[e]||b[f],b[f]<a[e]&&(a[e]=b[f]),a},{})},b.fn.percentage=function(a,b,c){var d=c.groupStament,e=a.field,f=a.as||"percentage",g=0,h=_.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c].total=(a[c].total||0)+b[e],g+=b[e],a}},{});return _.object(_.map(h,function(a,b){return a[f]=g&&a.total?a.total/g:0,a=_.omit(a,"total","count"),[b,a]}))},a.select=b.prototype.select=function(){var a,c=this,d=[].slice.call(arguments,0);if(c instanceof b)return c._select=_.map(d,function(b){return _.isString(b)?(a={},a[b]=_.iteratee(b),a):void 0}),c;var e=new b;return e.select.apply(e,d)},b.prototype.group=function(a){var b=this;return b.groupStament=a,b},b.prototype.from=function(a){var b=this;return b.dataset=a,b},b.prototype.order=function(a){var b=this;return b.orderStament=a,b},b.prototype.limit=function(a,b){var c=this;return c.limitStament=[a,b],c},b.prototype.where=function(a){var b=this;return b.whereStament=a,b},b.prototype.aggregate=function(a){var b=this;return b._aggregate.push(a),b},b.prototype.execute=function(){var a=this;a.result=a.groupStament?{}:[],a.scalar=a._aggregate.length&&!a.groupStament,a._filteredDataset=a.whereStament?_.filter(a.dataset,a.whereStament):a.dataset,a.scalar||_.each(a._filteredDataset,function(b,c){var d=a.groupStament?b[a.groupStament]:c;_.each(a._select,function(c){var e=_.values(c)[0],f=_.keys(c)[0];a.result[d]=a.result[d]||{},a.result[d][f]=e(b)})});var b={};return _.each(a._aggregate,function(c){var d=a._runAggregation(a.dataset,c);_.merge(b,d)}),a.scalar?(a.result=b,a.result):(_.merge(a.result,b),a.result=_.values(a.result),a.result=a.orderStament?_.sortBy(a.result,a.orderStament):a.result,a.result=a.limitStament?a.result.slice.apply(a.result,a.limitStament):a.result,a.result)},b.prototype._runAggregation=function(a,c){var d=this;return b.fn[c.method](c,d._filteredDataset,d)}}(window);