/*! CHANGE_NAME v0.1 */
!function(a){"use strict";function b(){var a=this;a._select=[],a._aggregate=[]}_.mixin({rename:function(a,b){return _.reduce(b,function(b,c,d){return _.has(a,d)?(b[c]=a[d],b):b},_.omit.apply(null,_.construct(a,_.keys(b))))},cat:function(){var a=_.first(arguments);return a?a.concat.apply(a,_.rest(arguments)):[]},construct:function(a,b){return _.cat([a],_.toArray(b))}}),b.fn={},b.fn.sum=function(a,b,c){var d=c.groupStament,e=a.field,f=a.as||a.field;return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][f]=(a[c][f]||0)+b[e],a}return a[f]=(a[f]||0)+b[e],a},{})},b.fn.count=function(a,b,c){var d=c.groupStament,e=a.as||"count";return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][e]=(a[c][e]||0)+1,a}return a[e]=(a[e]||0)+1,a},{})},b.fn.avg=function(a,b,c){var d=c.groupStament,e=a.field,f=a.as||"avg",g=_.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c].__total=(a[c].__total||0)+b[e],a[c].__count=(a[c].__count||0)+1,a[c].__count&&a[c].__total&&(a[c][f]=a[c].__total/a[c].__count),a}return a.__total=(a.__total||0)+b[e],a.__count=(a.__count||0)+1,a.__count&&a.__total&&(a[f]=a.__total/a.__count),a},{});return d?_.object(_.map(g,function(a,b){return[b,_.omit(a,"__total","__count")]})):_.omit(g,"__total","__count")},b.fn.max=function(a,b,c){var d=c.groupStament,e=a.as||"max",f=a.field;return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][e]=a[c][e]||b[f],b[f]>a[c][e]&&(a[c][e]=b[f]),a}return a[e]=a[e]||b[f],b[f]>a[e]&&(a[e]=b[f]),a},{})},b.fn.min=function(a,b,c){var d=c.groupStament,e=a.as||"min",f=a.field;return _.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c][e]=a[c][e]||b[f],b[f]<a[c][e]&&(a[c][e]=b[f]),a}return a[e]=a[e]||b[f],b[f]<a[e]&&(a[e]=b[f]),a},{})},b.fn.percentage=function(a,b,c){var d=c.groupStament,e=a.field,f=a.as||"percentage",g=0,h=_.reduce(b,function(a,b){if(d){var c=b[d];return a[c]=a[c]||{},a[c].__total=(a[c].__total||0)+b[e],g+=b[e],a}},{});return _.object(_.map(h,function(a,b){return a[f]=g&&a.__total?a.__total/g:0,a=_.omit(a,"__total","__count"),[b,a]}))},a.select=b.prototype.select=function(){var a,c=this,d=[].slice.call(arguments,0);if(c instanceof b)return c._select=_.map(d,function(b){return _.isString(b)?(a={},a[b]=_.iteratee(b),a):void 0}),c;var e=new b;return e.select.apply(e,d)},b.prototype.group=function(a){var b=this;return b.groupStament=a,b},b.prototype.from=function(a){var b=this;return b.dataset=a,b},b.prototype.order=function(a){var b=this;return b.orderStament=a,b},b.prototype.limit=function(a,b){var c=this;return c.limitStament=[a,b],c},b.prototype.where=function(a){var b=this;return b.whereStament=a,b},b.prototype.rename=function(a){var b=this;return b.renameStament=_.isArray(a)?a:[a],b},b.prototype.aggregate=function(a){var b=this;return b._aggregate.push(a),b},b.prototype.execute=function(a){var b=this;if(b.result=b.groupStament?{}:[],b.scalar=b._aggregate.length&&!b.groupStament,!_.isArray(b.dataset)&&_.isObject(b.dataset)){var c=new recline.Model.Dataset(b.dataset);return void c.fetch().done(function(c){b.dataset=c.records.toJSON(),a(b.execute())})}b._filteredDataset=b.whereStament?_.filter(b.dataset,b.whereStament):b.dataset,b.scalar||_.each(b._filteredDataset,function(a,c){var d=b.groupStament?a[b.groupStament]:c;_.each(b._select,function(c){var e=_.values(c)[0],f=_.keys(c)[0];b.result[d]=b.result[d]||{},b.result[d][f]=e(a)})}),_.each(b.result,function(a,c){_.each(b.renameStament,function(d){b.result[c]=_.rename(a,d)})});var d={};return _.each(b._aggregate,function(a){var c=b._runAggregation(b.dataset,a);_.merge(d,c)}),b.scalar?(b.result=d,b.result=d,b.result):(_.merge(b.result,d),b.result=_.values(b.result),b.result=b.orderStament?_.sortBy(b.result,b.orderStament):b.result,b.result=b.limitStament?b.result.slice.apply(b.result,b.limitStament):b.result,b.result)},b.prototype._runAggregation=function(a,c){var d=this;return b.fn[c.method](c,d._filteredDataset,d)}}(window);