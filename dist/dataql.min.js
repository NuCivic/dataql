/*! dataql v0.1 */
var CSV={};!function(a){"use strict";function b(a){return"\n"!==a.charAt(a.length-1)?a:a.substring(0,a.length-1)}a.__type__="csv",a.fetch=function(b){var c=DQ.Deferred();if(b.file){var d=new FileReader,e=b.encoding||"UTF-8";d.onload=function(d){var e=a.extractFields(a.parse(d.target.result,b),b);e.useMemoryStore=!0,e.metadata={filename:b.file.name},c.resolve(e)},d.onerror=function(a){alert("Failed to load file. Code: "+a.target.error.code)},d.readAsText(b.file,e)}else if(b.data){var f=a.extractFields(a.parse(b.data,b),b);f.useMemoryStore=!0,c.resolve(f)}else b.url&&DQ.ajax(b.url).get().then(function(d){var e=a.extractFields(a.parse(d,b),b);e.useMemoryStore=!0,c.resolve(e)});return c.promise},a.extractFields=function(a,b){if(b.noHeaderRow!==!0&&a.length>0){var c=a[0];return{fields:c,records:_.map(a.slice(1),_.partial(_.zipObject,c))}}return{records:a}},a.normalizeDialectOptions=function(a){var b={delimiter:",",doublequote:!0,lineterminator:"\n",quotechar:'"',skipinitialspace:!0,skipinitialrows:0};for(var c in a)"trim"===c?b.skipinitialspace=a.trim:b[c.toLowerCase()]=a[c];return b},a.parse=function(e,g){e=b(e);var h,i,j=a.normalizeDialectOptions(g),k="",l=!1,m=!1,n="",o=[],p=[];for(i=function(a){return m!==!0&&(""===a?a=null:j.skipinitialspace===!0&&(a=f(a)),c.test(a)?a=parseInt(a,10):d.test(a)&&(a=parseFloat(a,10))),a},h=0;h<e.length;h+=1)k=e.charAt(h),l!==!1||k!==j.delimiter&&"\n"!==k?k!==j.quotechar?n+=k:l?e.charAt(h+1)===j.quotechar?(n+=j.quotechar,h+=1):l=!1:(l=!0,m=!0):(n=i(n),o.push(n),"\n"===k&&(p.push(o),o=[]),n="",m=!1);return n=i(n),o.push(n),p.push(o),j.skipinitialrows&&(p=p.slice(j.skipinitialrows)),p},a.objectToArray=function(a){for(var b=[],c=[],d=0;d<a.fields.length;d++)c.push(a.fields[d].id);b.push(c);for(var d=0;d<a.records.length;d++){for(var e=[],f=a.records[d],g=0;g<c.length;g++)e.push(f[c[g]]);b.push(e)}return b},a.serialize=function(b,c){var d=null;d=b instanceof Array?b:a.objectToArray(b);var f,g,h,i=a.normalizeDialectOptions(c),j="",k="",l="",m="";for(h=function(a){return null===a?a="":"string"==typeof a&&e.test(a)?(i.doublequote&&(a=a.replace(/"/g,'""')),a=i.quotechar+a+i.quotechar):"number"==typeof a&&(a=a.toString(10)),a},f=0;f<d.length;f+=1)for(j=d[f],g=0;g<j.length;g+=1)k=h(j[g]),g===j.length-1?(l+=k,m+=l+"\n",l=""):l+=k+i.delimiter,k="";return m};var c=/^\d+$/,d=/^\d*\.\d+$|^\d+\.\d*$/,e=/^\s|\s$|,|"|\n/,f=function(){return String.prototype.trim?function(a){return a.trim()}:function(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")}}()}(CSV);var recline=recline||{};recline.Backend=recline.Backend||{},recline.Backend.CSV=CSV;var recline=recline||{};if(recline.Backend=recline.Backend||{},recline.Backend.GDocs=recline.Backend.GDocs||{},"undefined"!=typeof module&&null!=module&&"undefined"!=typeof require){var _=require("underscore");module.exports=recline}!function(a){a.__type__="gdocs",a.fetch=function(b){var c=DQ.Deferred(),d=a.getGDocsApiUrls(b.url,b.worksheetIndex);return function(){var a=DQ.Deferred();return DQ.ajax(d.spreadsheetAPI).get().then(function(b){var b=JSON.parse(b);a.resolve({spreadsheetTitle:b.feed.title.$t})})["catch"](function(b){a.reject(b)}),a.promise}().then(function(b){DQ.ajax(d.worksheetAPI).get().then(function(e){var e=JSON.parse(e),f=a.parseData(e),g=_.map(f.fields,function(a){return{id:a}}),h=_.extend(d,{title:b.spreadsheetTitle+" - "+f.worksheetTitle,spreadsheetTitle:b.spreadsheetTitle,worksheetTitle:f.worksheetTitle});c.resolve({metadata:h,records:f.records,fields:g,useMemoryStore:!0})})})["catch"](function(a){c.reject(a)}),c.promise},a.parseData=function(a,b){var c,d,b=b||{},e=b.colTypes||{},f={fields:[],records:[]},g=a.feed.entry||[],h=/^([\d\.\-]+)\%$/;for(c in g[0])/^gsx/.test(c)&&(d=c.substr(4),f.fields.push(d));return f.records=_.map(g,function(a){var b={};return _.each(f.fields,function(c){var d,f="gsx$"+c,g=a[f].$t;"percent"===e[c]&&h.test(g)&&(d=h.exec(g)[1],g=parseFloat(d)/100),b[c]=g}),b}),f.worksheetTitle=a.feed.title.$t,f},a.getGDocsApiUrls=function(a,b){var c=/.*spreadsheet\/ccc\?.*key=([^#?&+]+)[^#]*(#gid=([\d]+).*)?/,d=/.*spreadsheets\/d\/([^\/]+)\/edit(#gid=([\d]+).*)?/;return matches=a.match(c),matches2=a.match(d),matches?(key=matches[1],worksheet=parseInt(matches[3])+1,isNaN(worksheet)&&(worksheet=1)):matches2?(key=matches2[1],worksheet=1,isNaN(worksheet)&&(worksheet=1)):-1!=a.indexOf("spreadsheets.google.com/feeds")?(key=a.split("/")[5],worksheet=1):(key=a,worksheet=1),worksheet=b||0===b?b:worksheet,{worksheetAPI:"https://spreadsheets.google.com/feeds/list/"+key+"/"+worksheet+"/public/values?alt=json",spreadsheetAPI:"https://spreadsheets.google.com/feeds/worksheets/"+key+"/public/basic?alt=json",spreadsheetKey:key,worksheetIndex:worksheet}}}(recline.Backend.GDocs);var Inline={};!function(a){"use strict";a.__type__="inline",a.fetch=function(a){var b=DQ.Deferred();return b.resolve(a),b.promise}}(Inline);var recline=recline||{};recline.Backend=recline.Backend||{},recline.Backend.Inline=Inline;var PapaCSV={};!function(a){"use strict";a.__type__="papacsv",a.fetch=function(b){var c=DQ.Deferred(),d={complete:_.partial(a._complete,_,c,b)};return b.file?Papa.parse(b.file,d):b.data?Papa.parse(b.data,d):b.url&&(d.download=!0,Papa.parse(b.url,d)),c.promise},a._complete=function(b,c,d){var e=a.extractFields(b.data,d);e.useMemoryStore=!0,c.resolve(e)},a.extractFields=function(a,b){return b.noHeaderRow!==!0&&a.length>0?{fields:a[0],records:a.slice(1)}:{records:a}}}(PapaCSV);var recline=recline||{};recline.Backend=recline.Backend||{},recline.Backend.PapaCSV=PapaCSV,function(a){"use strict";function b(){var a=this;a._tables=[],a._operations=[],a._result=[]}b.operators={},b.operators["="]=function(a,b){return a==b},b.operators[">"]=function(a,b){return a>b},b.operators["<"]=function(a,b){return b>a},b.operators[">="]=function(a,b){return a>=b},b.operators["<="]=function(a,b){return b>=a},b.prototype._getCmp=function(a){if(!_.isFunction(b.operators[a]))throw new Error("Operator not supported");return b.operators[a]},b.prototype._join=function(a,b,c){var d=this,e=[],f=d._getCmp(c.where.cmp);return _.has(a,c.table)&&(e=a[c.table].records),_.map(b,function(a){var b=_.filter(e,function(b){return f(a[c.where.left],b[c.where.right])});return _.extend(a,_.first(b))})},b.prototype._set=function(a,b,c){if(!_.has(a,c.table))throw new Error("Table not fetched. Fetch and name the table before set.");return a[c.table].records},b.prototype._filter=function(a,b,c){var d=this,e=d._getCmp(c.where.cmp);return _.filter(b,function(a){return e(a[c.where.left],c.where.right)})},b.prototype._limit=function(a,b,c){return b.slice(c.start,c.start+c.numRows)},b.prototype._sort=function(a,b,c){var d="desc"===c.order?!1:!0,e=c.field;return _.sortByOrder(b,e,d)},b.prototype._rename=function(a,b,c){return _.map(b,function(a){return a[c.newName]=a[c.oldName],_.omit(a,c.oldName)})},b.prototype._delete=function(a,b,c){return _.map(b,function(a){return _.omit(a,c.field)})},b.prototype._add=function(a,b,c){var d=this,e="column"===c.type?"addColumn":"addRow";return d["_"+e](a,b,c)},b.prototype._addColumn=function(a,b,c){var d=this,e=d._range(a,b,c.from);return _.map(b,function(a,b){return a[c.field]=e[b],a})},b.prototype._addRow=function(a,b,c){var d=this,e=d._range(a,b,c.from),f=_.first(b).keys();return b.push(d.toMap(Array.from(f),e)),b},b.prototype._groupBy=function(a,b,c){var d=_.values(_.groupBy(b,c.field));return _.map(d,function(a){return a[0]})},b.prototype._range=function(a,b,c){var d=this,e="column"===c.type?"vectorFromColumns":"vectorFromRows";return d["_"+e](a,c)},b.prototype._vectorFromColumns=function(a,b){var c=a[b.table].records[b.row],d=[],e=0;return c.forEach(function(a){(e>=b.from||e<=b.to)&&d.push(a),++e}),d},b.prototype._vectorFromRows=function(a,b){var c=a[b.table].records;return _.reduce(c,function(a,c,d){return d>=b.from&&d<=b.to&&a.push(c[b.field]),a},[])},b.prototype._runOps=function(){var a=this;return _.each(a._operations,function(b){a._result=a["_"+b.method](a._resources,a._result,_.omit(b,"method"))}),a},b.prototype._backendFromString=function(a){return _.findWhere(recline.Backend,{__type__:a})},b.prototype._fetchResources=function(){var a=this,b=[];return _.each(a._tables,function(c){var d=a._backendFromString(c.backend);if(!d)throw new Error("Backend not found");b.push(d.fetch(c))}),Promise.all(b)},b.prototype._trim=function(a,c,d){var e=d.fields;return _.map(c,function(a){return _.mapValues(a,function(a,c){return _.includes(e,c)?b.trim(a):a})})},b.prototype._cast=function(a,c,d){var e=_.pluck(d.fields,"field");return _.map(c,function(a){return _.mapValues(a,function(a,c){if(_.contains(e,c)){var f=_.findWhere(d.fields,{field:c}),g=f.type,h=f.args;return b.cast.apply(null,[a,g].concat(h))}return a})})},b.prototype._substr=function(a,b,c){var d=c.field,e=c.start,f=c.end;return _.map(b,function(a){return a[d]=String(a[d]).substring(e,f),a})},b.prototype.tables=function(){var a=this;if(a instanceof b)return a._resources={},a._tables=_.toArray(arguments),a;var c=new b;return c.tables.apply(c,_.toArray(arguments))},b.prototype.ops=function(a){var b=this;return b._operations=a,b},b.prototype.execute=function(a){var b=this,c=_.pluck(b._tables,"as");b._fetchResources().then(function(d){b._resources=_.zipObject(c,d),b._runOps(),a(b._result)})},a.DQ=a.DQ=b,a.tables=b.prototype.tables}(window),function(){"use strict";DQ.prototype._sum=function(a,b,c){return _.values(_.reduce(b,function(a,b){var d=b[c.groupBy],e=c.field,f=c.as||e,g=Number(b[e]);return d in a?a[d][f]=Number(a[d][f])+g:(a[d]=b,a[d][f]=g),a},{}))},DQ.prototype._avg=function(a,b,c){var d,e=c.field,f=c.as||"avg",g=_.values(_.reduce(b,function(a,b){var f=b[c.groupBy],g=Number(b[e]);return f in a?(d=Number(a[f][e]),a[f].__total=Number(a[f].__total)+g,a[f].__count=d+1):(a[f]=b,a[f].__total=g,a[f].__count=1),a},{}));return _.map(g,function(a){return a[f]=a.__total/a.__count,_.omit(a,"__total","__count")})},DQ.prototype._percentage=function(a,b,c){var d=c.field,e=c.as||"percentage",f=0,g=_.values(_.reduce(b,function(a,b){var e=b[c.groupBy],g=Number(b[d]);return e in a?a[e].__total=Number(a[e].__total)+g:(a[e]=b,a[e].__total=g),f+=g,a},{}));return _.map(g,function(a){return a[e]=a.__total/f,_.omit(a,"__total")})},DQ.prototype._max=function(a,b,c){return _.values(_.reduce(b,function(a,b){var d,e=b[c.groupBy],f=c.field,g=c.as||f,h=Number(b[f]);return e in a?(d=Number(a[e][g]),h>d&&(a[e][g]=h)):(a[e]=b,a[e][g]=h),a},{}))},DQ.prototype._min=function(a,b,c){return _.values(_.reduce(b,function(a,b){var d,e=b[c.groupBy],f=c.field,g=c.as||f,h=Number(b[f]);return e in a?(d=Number(a[e][g]),d>h&&(a[e][g]=h)):(a[e]=b,a[e][g]=h),a},{}))},DQ.prototype._count=function(a,b,c){return _.values(_.reduce(b,function(a,b){var d,e=b[c.groupBy],f=c.as||"count";return e in a?(d=Number(a[e][f]),a[e][f]=d+1):(a[e]=b,a[e][f]=1),a},{}))}}(window),function(){"use strict";var a={string:String,"boolean":Boolean,number:Number,date:Date,integer:parseInt,"float":parseFloat};DQ.trim=function(a){return a.replace(/^\s+|\s+$/gm,"")},DQ.cast=function(b,c){var d=_.drop(_.toArray(arguments),2);return a[c].apply(null,[b].concat(d))},DQ.ajax=function(a){var b={ajax:function(a,b,c){var d=new Promise(function(d,e){var f=new XMLHttpRequest,g=b;if(c&&("POST"===a||"PUT"===a)){g+="?";var h=0;for(var i in c)c.hasOwnProperty(i)&&(h++&&(g+="&"),g+=encodeURIComponent(i)+"="+encodeURIComponent(c[i]))}f.open(a,g),f.send(),f.onload=function(){200==this.status?d(this.response):e(this.statusText)},f.onerror=function(){e(this.statusText)}});return d}};return{get:function(c){return b.ajax("GET",a,c)},post:function(c){return b.ajax("POST",a,c)},put:function(c){return b.ajax("PUT",a,c)},"delete":function(c){return b.ajax("DELETE",a,c)}}},DQ.Deferred=function(){if(Promise&&Promise.defer)return Promise.defer();if(PromiseUtils&&PromiseUtils.defer)return PromiseUtils.defer();try{this.resolve=null,this.reject=null,this.promise=new Promise(function(a,b){this.resolve=a,this.reject=b}.bind(this)),Object.freeze(this)}catch(a){throw new Error("Promise/Deferred is not available")}}}(window);